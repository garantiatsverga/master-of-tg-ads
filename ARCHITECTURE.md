# Архитектура системы

Этот документ описывает архитектуру системы и связи между основными компонентами.

## Общая архитектура

```
┌───────────────────────────────────────────────────────────────────────────────┐
│                                                                               │
│                                AI Assistant                                    │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌───────────────────────────────────────────────────────────────────────────────┐
│                                                                               │
│                              MCP Server                                      │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌───────────────────────────────────────────────────────────────────────────────┐
│                                                                               │
│                              Agents Layer                                    │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌───────────────────────────────────────────────────────────────────────────────┐
│                                                                               │
│                              Tools Layer                                     │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
```

## Связь между BannerDesignerAgent и ImageGenerationTool

```
┌───────────────────────────────────────────────────────────────────────────────┐
│                                                                               │
│                          BannerDesignerAgent                                 │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ (вызывает через MCPServer)
                                      ▼
┌───────────────────────────────────────────────────────────────────────────────┐
│                                                                               │
│                              MCP Server                                      │
│                                                                               │
│  - Регистрация инструментов                                                   │
│  - Управление разрешениями                                                   │
│  - Выполнение инструментов                                                    │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ (вызывает инструмент)
                                      ▼
┌───────────────────────────────────────────────────────────────────────────────┐
│                                                                               │
│                          ImageGenerationTool                                 │
│                                                                               │
│  - Генерация изображения в низком разрешении (640x360)                         │
│  - Апскейл изображения до высокого разрешения (1920x1080)                      │
│  - Возврат URL сгенерированного изображения                                    │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ (использует)
                                      ▼
┌───────────────────────────────────────────────────────────────────────────────┐
│                                                                               │
│                          StableDiffusionAdapter                               │
│                                                                               │
│  - Взаимодействие с Stable Diffusion API                                      │
│  - Генерация изображений                                                      │
│  - Апскейл изображений                                                        │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
```

## Процесс генерации баннера

1. **BannerDesignerAgent** получает контекст с `target_image_prompt`
2. **BannerDesignerAgent** вызывает `mcp.call("image.generate", ...)`
3. **MCPServer** находит зарегистрированный инструмент `ImageGenerationTool`
4. **ImageGenerationTool** выполняет генерацию изображения:
   - Генерация в низком разрешении (640x360)
   - Апскейл до высокого разрешения (1920x1080)
   - Возврат URL изображения
5. **BannerDesignerAgent** получает URL изображения и сохраняет его в контексте
6. **BannerDesignerAgent** возвращает обновленный контекст с `banner_url`

## Код связи

### Регистрация инструмента в MCPServer

```python
# В ui/streamlit_app.py или ai_assistant.py
registry = ToolRegistry()
registry.register(ImageGenerationTool())  # Регистрация инструмента

mcp_server = MCPServer(registry=registry, ...)
banner_agent = BannerDesignerAgent(mcp_server=mcp_server)
```

### Регистрация разрешений

```python
# В BannerDesignerAgent._register_agent_permissions()
self.mcp.set_agent_permissions(self.name, ["image.generate"])
```

### Вызов инструмента

```python
# В BannerDesignerAgent.process()
response = await self.mcp.call(
    "image.generate",
    agent_name=self.name,
    prompt=image_prompt,
    size="1024x1024",
    quality="standard"
)
```

## Поток данных

```
┌───────────────────────────────────────────────────────────────────────────────┐
│                                                                               │
│                          Входные данные                                       │
│                                                                               │
│  context = {"target_image_prompt": "красивый закат на море"}                 │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌───────────────────────────────────────────────────────────────────────────────┐
│                                                                               │
│                          BannerDesignerAgent                                 │
│                                                                               │
│  - Извлекает prompt из контекста                                              │
│  - Вызывает mcp.call("image.generate", ...)                                 │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌───────────────────────────────────────────────────────────────────────────────┐
│                                                                               │
│                              MCP Server                                      │
│                                                                               │
│  - Проверяет разрешения агента                                               │
│  - Находит инструмент "image.generate"                                      │
│  - Выполняет инструмент                                                      │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌───────────────────────────────────────────────────────────────────────────────┐
│                                                                               │
│                          ImageGenerationTool                                 │
│                                                                               │
│  - Генерирует изображение в низком разрешении (640x360)                         │
│  - Апскейлит изображение до высокого разрешения (1920x1080)                    │
│  - Возвращает {"image_url": "generated_image_красивый_закат_на_море.png"}     │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌───────────────────────────────────────────────────────────────────────────────┐
│                                                                               │
│                          BannerDesignerAgent                                 │
│                                                                               │
│  - Получает URL изображения                                                   │
│  - Сохраняет в контексте                                                      │
│  - Возвращает context["banner_url"]                                         │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌───────────────────────────────────────────────────────────────────────────────┐
│                                                                               │
│                          Выходные данные                                      │
│                                                                               │
│  context = {"banner_url": "generated_image_красивый_закат_на_море.png"}     │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘
```

## Заключение

`BannerDesignerAgent` и `ImageGenerationTool` связаны через `MCPServer`, который выступает в роли посредника. `BannerDesignerAgent` не знает о существовании `ImageGenerationTool` напрямую — он только знает, что может вызвать инструмент с именем `image.generate` через `MCPServer`. Это позволяет легко заменять инструменты без изменения кода агентов.